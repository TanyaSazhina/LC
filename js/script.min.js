function testWebP(callback) {
  var webP = new Image();
  webP.onload = webP.onerror = function () {
    callback(webP.height == 2);
  };
  webP.src =
    "data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA";
}

testWebP(function (support) {
  if (support == true) {
    document.querySelector("body").classList.add("webp");
  } else {
    document.querySelector("body").classList.add("no-webp");
  }
});
$("#search").focus(function () {
  $(".header__search").addClass("active__search");
});
$("#search").blur(function () {
  setTimeout(function () {
    $(".header__search").removeClass("active__search");
  }, 200);
});
$(".who__content").marquee({});
$(".question__title").click(function () {
  $(this).parent().toggleClass("question__active");
});
$(".filter-item__view-stroke").click(function () {
  $(".filter-item__view-block").removeClass("filter-item__view-item-active");
  $(this).addClass("filter-item__view-item-active");
  $(".catalog__content").addClass("catalog__content-active");
});
$(".filter-item__view-block").click(function () {
  $(".filter-item__view-stroke").removeClass("filter-item__view-item-active");
  $(this).addClass("filter-item__view-item-active");
  $(".catalog__content").removeClass("catalog__content-active");
});
$(".filter-item").focus(function () {
  $(".filter-item").removeClass("filter-item__active");
  $(".filter-item .filter-item__title-icon").removeClass(
    "filter-item__title-icon-active"
  );
  $(this).addClass("filter-item__active");
  $(`.filter-item__title-icon`).addClass("filter-item__title-icon-active");
});
$(".filter-item").blur(function () {
  $(".filter-item").removeClass("filter-item__active");
  $(".filter-item .filter-item__title-icon").removeClass(
    "filter-item__title-icon-active"
  );
});

const musicContainer = document.getElementById("music-container");
const audioPlayer = musicContainer.querySelector(".audio_player");

const title = document.getElementById("title");
//
const progressRange = document.querySelector(".progress-range");
const progressBar = document.querySelector(".progress-bar");
//
// const progressContainer = document.getElementById('progress-container');
// const progress = document.getElementById('progress');

const currentTime = document.querySelector(".time-elapsed");
const duration = document.querySelector(".time-duration");

const audio = document.getElementById("audio");

const prevBtn = document.getElementById("prev");
const playBtn = document.getElementById("play");
const nextBtn = document.getElementById("next");

const speaker = musicContainer.querySelector(".speaker");
const speakerIcon = musicContainer.querySelector("#speaker_icon");

const ranges = musicContainer.querySelectorAll(".player_slider");
const volInput = musicContainer.querySelector('input[name="volume"]');

// const cover = document.getElementById('cover');

// Song Titles - need to get rid of this hard coded list of titles. Need to be able to upload multiple files from desktop or load a list from an API
const songs = [
  "../demo17.mp3",
  "Little Paradise",
  "Molasses",
  "Moon",
  "Summer",
  "Ukulele",
  "Hey",
];

// Keep track of song
let songIndex = 0;

function loadSong(song) {
  audio.src = song;
  // need an array of songs, either on the user's harddrive or another website
  //  audio.src = `../demo17.mp3`;
  // cover.src = `images/${song}.jpg`;
}

// remove Play icon, add Pause icon
function playSong() {
  musicContainer.classList.add("play");
  playBtn.querySelector("i.fas").classList.remove("fa-play");
  playBtn.querySelector("i.fas").classList.add("fa-pause");

  audio.play();
}

// remove Pause icon, add Play icon
// why aren't these combined into a play\pause toggle function?
function pauseSong() {
  musicContainer.classList.remove("play");
  playBtn.querySelector("i.fas").classList.add("fa-play");
  playBtn.querySelector("i.fas").classList.remove("fa-pause");

  audio.pause();
}

// previous song
function prevSong() {
  var acviveSong = $("audio").attr("src");
  var prevSong = $('.player-link[data-src="' + acviveSong + '"]');
  var prev = prevSong.parent().parent().prev(".item").find(".player-link");
  if (prev.length > 0) {
    var song = prevSong
      .parent()
      .parent()
      .prev(".item")
      .find(".player-link")
      .attr("data-src");
    var cover = prevSong
      .parent()
      .parent()
      .prev(".item")
      .find(".player-link")
      .attr("data-cover");
    var name = prevSong
      .parent()
      .parent()
      .prev(".item")
      .find(".player-link")
      .attr("data-name");
    var aurhor = prevSong
      .parent()
      .parent()
      .prev(".item")
      .find(".player-link")
      .attr("data-aurhor");
    $("#player-cover").attr("src", cover);
    $("#player-name").text(name);
    $("#player-aurhor").html(aurhor);
    loadSong(song);
    playSong();
  } else {
    playSong();
  }
}

// next song
function nextSong() {
  var acviveSong = $("audio").attr("src");
  var nextSong = $('.player-link[data-src="' + acviveSong + '"]');
  var nexx = nextSong.parent().parent().next(".item").find(".player-link");
  if (nexx.length > 0) {
    var song = nextSong
      .parent()
      .parent()
      .next(".item")
      .find(".player-link")
      .attr("data-src");
    var cover = nextSong
      .parent()
      .parent()
      .next(".item")
      .find(".player-link")
      .attr("data-cover");
    var name = nextSong
      .parent()
      .parent()
      .next(".item")
      .find(".player-link")
      .attr("data-name");
    var aurhor = nextSong
      .parent()
      .parent()
      .next(".item")
      .find(".player-link")
      .attr("data-aurhor");
    $("#player-cover").attr("src", cover);
    $("#player-name").text(name);
    $("#player-aurhor").html(aurhor);
    loadSong(song);
    playSong();
  } else {
    playSong();
  }
}

// update progress bar
// function updateProgress(e) {
//   const { duration, currentTime } = e.srcElement;
//   const progressPercent = (currentTime / duration) * 100;
//   progress.style.width = `${progressPercent}%`;
//   console.log('Working');
// }

/* updateProgress - the above one stops progress, the one below works but get NaN */

// VIDEO - - - - - - -Calculate display time format
// IT'S THIS FUNCTION, THE SECONDS

function displayTime(time) {
  const minutes = Math.floor(time / 60);
  let seconds = Math.floor(time % 60);
  seconds = seconds > 9 ? seconds : `0${seconds}`;
  return `${minutes}:${seconds}`;
  // return minutes + ':' + seconds;
}

// VIDEO - - - - - - - update progress bar as the video plays
// OR THIS FUNCTION, DURATION IS A PROPERTY OF THE VIDEO ELEMENT, WHAT ABOUT THE AUDIO ELEMENT? ad to comment out time-duration in index.html

function updateProgress() {
  //   added this to stop the NaN displaying, seems to work
  let duration = 0;
  progressBar.style.width = `${
    (audioPlayer.currentTime / audioPlayer.duration) * 100
  }%`;
  currentTime.textContent = `${displayTime(audioPlayer.currentTime)} /`;
  // currentTime.textContent = `${displayTime(audioPlayer.currentTime)}`;
  duration.textContent =
    // had to comment out the duration
    `${displayTime(audioPlayer.duration)}`;
}
// VIDEO - - - - -
function scrub(event) {
  const scrubTime =
    (event.offsetX / progressRange.offsetWidth) * audioPlayer.duration;
  audioPlayer.currentTime = scrubTime;
}

// from https://css-tricks.com/lets-create-a-custom-audio-player/ but only got rid of the initial load - search: html5 audio element duration NaN
const displayDuration = () => {
  duration.textContent = displayTime(audio.duration);
};

if (audio.readyState > 0) {
  displayDuration();
} else {
  audio.addEventListener("loadedmetadata", () => {
    displayDuration();
  });
}

// set progress bar
// function setProgress(e) {
//   const width = this.clientWidth;
//   const clickX = e.offsetX;
//   const duration = audio.duration;

//   audio.currentTime = (clickX / width) * duration;
// }
// VIDEO - - - - - Click to seek within the video
function setProgress(e) {
  const newTime = e.offsetX / progressRange.offsetWidth;
  progressBar.style.width = `${newTime * 100}%`;
  audioPlayer.currentTime = newTime * audioPlayer.duration;
}

// ==================== VOLUME CONTROLS

// volume functions
function handleRangeUpdate() {
  audioPlayer[this.name] = this.value;
  audioPlayer["volume"] === 0
    ? (speakerIcon.className = "fa fa-volume-off")
    : (speakerIcon.className = "fa fa-volume-up");
}

let muted = false;

// need to have the muste button return to previous setting, not back to full
function mute() {
  if (!muted) {
    audioPlayer["volume"] = 0;
    volInput.value = 0;
    speakerIcon.className = "fa fa-volume-off";
    muted = true;
  } else {
    audioPlayer["volume"] = 1;
    volInput.value = 1;
    muted = false;
    speakerIcon.className = "fa fa-volume-up";
  }
}

// ==================== END VOLUME CONTROLS

// Event Listeners
playBtn.addEventListener("click", () => {
  const isPlaying = musicContainer.classList.contains("play");

  if (isPlaying) {
    pauseSong();
  } else {
    playSong();
  }
});
$(".player-link").click(function () {
  var song = $(this).attr("data-src");
  var cover = $(this).attr("data-cover");
  var name = $(this).attr("data-name");
  var aurhor = $(this).attr("data-aurhor");
  $("#player-cover").attr("src", cover);
  $("#player-name").text(name);
  $("#player-aurhor").html(aurhor);
  loadSong(song);
  playSong();
});
// Change Song
prevBtn.addEventListener("click", prevSong);
nextBtn.addEventListener("click", nextSong);

// time and song update
audio.addEventListener("timeupdate", updateProgress);

// click on progrss bar
// progressContainer.addEventListener('click', setProgress);
// VIDEO
progressRange.addEventListener("click", setProgress);

// preload metadata

// song ends
audio.addEventListener("ended", nextSong);

// volume
ranges.forEach((range) => range.addEventListener("change", handleRangeUpdate));
ranges.forEach((range) =>
  range.addEventListener("mousemove", handleRangeUpdate)
);
speaker.addEventListener("click", mute);

// progress bar controls
let mouseDown = false;
progressRange.addEventListener("click", scrub);
progressRange.addEventListener(
  "mousemove",
  (event) => mouseDown && scrub(event)
);
progressRange.addEventListener("mousedown", () => (mouseDown = true));
progressRange.addEventListener("mouseup", () => (mouseDown = false));

// ignore the massive amount of lines commented out - will fix later
// the song titles refer to the songs on my computer - you could hard code the title if the HTML if you only intend to use this for one song
// I can't figure out how to get rid of Nan for the element
$(".log").click(function () {
  $("body").toggleClass("lock");
  $(".display-form").toggleClass("show");
});
$(".formpopup__sing-link").click(function () {
  $(".register-form").animate({ height: "hide", opacity: "hide" }, 0);
  $(".login-form").animate({ height: "show", opacity: "show" }, 0);
  $(this).addClass("formpopup__active-link");
  $(".formpopup__reg-link").removeClass("formpopup__active-link");
});
$(".formpopup__reg-link").click(function () {
  $(".login-form").animate({ height: "hide", opacity: "hide" }, 0);
  $(".register-form").animate({ height: "show", opacity: "show" }, 0);
  $(".formpopup__sing-link").removeClass("formpopup__active-link");
  $(this).addClass("formpopup__active-link");
});
$(".display-form__link").click(function () {
  $("body").toggleClass("lock");
  $(".display-form").toggleClass("show");
});
$(".log-out").click(function () {
  $(".log-out").hide();
  $(".log-in").show();
  $(".register").show();
});
$(".profile-social__item").hover(
  function () {
    $(this).removeClass("fill-gray");
  },
  function () {
    $(this).addClass("fill-gray");
  }
);
$(".settings-user, .popup-setting__close, .footer__settings-user").click(
  function () {
    $("body").toggleClass("lock");
    $(".popup-setting").toggleClass("show");
  }
);
$(".add-track, .popup-addtrack__close, .footer__add-track").click(function () {
  $("body").toggleClass("lock");
  $(".popup-addtrack").toggleClass("show");
});
function getData(obj_form) {
  // функция для получения данных из формы
  var hData = {};
  $("input, textarea", obj_form).each(function () {
    if (this.name && this.name != "") {
      hData[this.name] = this.value;
      console.log("hData: {" + this.name + "} = " + hData[this.name]);
    }
  });
  return hData;
}

function registerNewUser() {
  // функция регистрации
  var postData = getData(".register-form"); // собирает все значения из формы
  $.ajax({
    dataType: "json",
    url: "components/reg.php",
    method: "POST",
    async: true,
    data: postData,
    success: function (data) {
      if (data["success"] == 1) {
        location.reload();
      } else {
        alert(data["message"]);
      }
    },
  });
}

function loginUser() {
  var postData = getData(".login-form");
  $.ajax({
    method: "POST",
    url: "../components/log.php",
    data: postData,
    dataType: "json",
    success: function (data) {
      if (data["success"] == 1) {
        location.reload();
      } else {
        alert(data["message"]);
      }
    },
  });
}
function subscribe() {
  var postData = getData(".banner__form");
  $.ajax({
    method: "POST",
    url: "../components/sub.php",
    data: postData,
    dataType: "json",
    success: function (data) {
      alert(data["message"]);
    },
  });
}

function addToFavourites(itemId) {
  $.ajax({
    dataType: "json",
    url: "../components/addToFavorites.php?id=" + itemId,
    method: "POST",
    async: true,
    success: function (data) {
      if (data["success"]) {
        $("#addFavorites_" + itemId).hide();
        $("#removeFavorites_" + itemId).show();
      }
    },
    error: function (request, status, error) {
      alert(request.responseText);
    },
  });
}
function removeFromFavourites(itemId) {
  $.ajax({
    dataType: "json",
    url: "../components/removeFromFavorites.php?id=" + itemId,
    method: "POST",
    success: function (data) {
      if (data["success"]) {
        $("#removeFavorites_" + itemId).hide();
        $("#addFavorites_" + itemId).show();
      }
    },
  });
}
